<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>The Resistance — Upload and Run</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            margin: 24px;
        }

        .card {
            background: #fff;
            border: 1px solid #eee;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        textarea {
            width: 100%;
            height: 360px;
            white-space: pre;
        }

        code.badge {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
        }
    </style>
</head>

<body>
    <h1>The Resistance — Upload and Run</h1>

    <div class="card">
        <h2>Upload Agent (.py)</h2>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept=".py" required>
            <button type="submit">Upload to game_core/agents/</button>
        </form>
        {% with msgs=get_flashed_messages() %}{% if msgs %}
        <ul>{% for m in msgs %}<li>{{ m }}</li>{% endfor %}</ul>
        {% endif %}{% endwith %}
        <p>Detected Agents:
            {% if agent_names %}
            {% for n in agent_names %}<code class="badge">{{ n }}</code>{% endfor %}
            {% else %}
            <em>None (please upload first)</em>
            {% endif %}
        </p>
    </div>

    <div class="card">
        <h2>Run One Game</h2>
        
        <button id="run">Run</button>
    </div>

    <div class="card">
        <h2>Result Log</h2>
        <textarea id="output" readonly placeholder="Click Run to start..."></textarea>
        <h3>Error Log</h3>
        <pre id="errors" style="background:#fafafa;border:1px solid #eee;padding:12px;"></pre>
    </div>

    <!-- tounament run -->
    <div class="card">
        <h2>Run Tournament</h2>
        <label>Game rounds:<input id="tgames" type="number" value="10"></label>
        &nbsp;&nbsp;
        <p>Detected Agents:
            {% if agent_names %}
            {% for n in agent_names %}<code class="badge">{{ n }}</code>{% endfor %}
            {% else %}
            <em>None (please upload first)</em>
            {% endif %}
        </p>
        <p>Total player: {{ agent_names | length }}</p>
        &nbsp;&nbsp;
        <button id="tournamentBtn">Run Tournament</button>
    </div>

    <div class="card">
        <h2>Tournament Result</h2>
        <pre id="tournamentResult"></pre>
    </div>

    <script>
        const runBtn = document.getElementById('run');
        const out = document.getElementById('output');
        const errs = document.getElementById('errors');
        runBtn.onclick = async () => {
            out.value = 'Running...'; errs.textContent = '';
            const payload = {};
            const res = await fetch('/play', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (!data.ok) { out.value = data.log || 'Error'; return; }
            out.value = data.log;
            //errs.textContent = 'Errors by agent class:\n' + JSON.stringify(data.errors || {}, null, 2) + '\nPlayers: ' + data.players;
        };


        const tBtn = document.getElementById('tournamentBtn');
        const tOut = document.getElementById('tournamentResult');
        tBtn.onclick = async () => {
            tOut.textContent = 'Running tournament...';
            const payload = {};
            const games = document.getElementById('tgames').value;
            if (games) payload.games = Number(games);
            const res = await fetch('/tournament', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.ok) { tOut.textContent = data.msg || 'Error'; return; }
            tOut.textContent = JSON.stringify(data, null, 2);
        };
    </script>
</body>

</html>